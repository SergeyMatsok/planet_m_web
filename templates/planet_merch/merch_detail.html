{% extends 'base.html' %}
{% load static %}

{% block title %}{{ item.title }} ‚Äî –ú–µ—Ä—á{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="mb-4">
        <a href="{% url 'merch_list' %}" class="btn btn-outline-secondary">
            ‚Üê –í—Å–µ —Ç–æ–≤–∞—Ä—ã
        </a>
    </div>

    <div class="row">
        <!-- –§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞ -->
        <div class="col-md-6 mb-4 mb-md-0">
            <div class="position-relative">
                {% if item.is_new %}
                <span class="badge bg-success position-absolute top-0 start-0 m-2">–ù–æ–≤–∏–Ω–∫–∞</span>
                {% endif %}
                {% if item.get_discount_percent > 0 %}
                <span class="badge bg-danger position-absolute top-0 end-0 m-2">
                    -{{ item.get_discount_percent }}%
                </span>
                {% endif %}
                <img src="{{ item.image.url }}" class="img-fluid rounded" alt="{{ item.title }}">
            </div>
            
            {% if item.additional_images.exists %}
            <div class="row mt-3">
                {% for img in item.additional_images.all %}
                <div class="col-3">
                    <img src="{{ img.image.url }}" class="img-fluid rounded" alt="{{ img.alt_text }}">
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ -->
        <div class="col-md-6">
            <h1>{{ item.title }}</h1>
            
            <div class="d-flex align-items-baseline mb-3">
                {% if item.old_price and item.old_price > item.price %}
                <span class="text-muted text-decoration-line-through me-2 fs-3">
                    {{ item.old_price }} ‚ÇΩ
                </span>
                {% endif %}
                <span class="fs-1 fw-bold text-white">
                    {{ item.price }} ‚ÇΩ
                </span>
            </div>
            
            <p class="lead">{{ item.description }}</p>
            
            <div class="mb-3">
                <strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> 
                {% if item.category == 'clothing' %}–û–¥–µ–∂–¥–∞{% endif %}
                {% if item.category == 'accessories' %}–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã{% endif %}
                {% if item.category == 'vinyl' %}–í–∏–Ω–∏–ª{% endif %}
                {% if item.category == 'cd' %}CD{% endif %}
                {% if item.category == 'other' %}–î—Ä—É–≥–æ–µ{% endif %}
            </div>
            
            <div class="mb-3">
                <strong>–°—Ç–∞—Ç—É—Å:</strong>
                {% if item.status == 'in_stock' %}
                <span class="badge bg-success">–í –Ω–∞–ª–∏—á–∏–∏</span>
                {% elif item.status == 'low_stock' %}
                <span class="badge bg-warning text-dark">–ú–∞–ª–æ –Ω–∞ —Å–∫–ª–∞–¥–µ</span>
                {% elif item.status == 'out_of_stock' %}
                <span class="badge bg-danger">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>
                {% elif item.status == 'pre_order' %}
                <span class="badge bg-info text-dark">–ü—Ä–µ–¥–∑–∞–∫–∞–∑</span>
                {% endif %}
                
                {% if item.stock_quantity > 0 %}
                <span class="ms-2">–û—Å—Ç–∞–ª–æ—Å—å: {{ item.stock_quantity }} —à—Ç.</span>
                {% endif %}
            </div>
            

<!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∑–∞–∫–∞–∑–∞ -->
<div class="mb-4">
    {% if item.status == 'in_stock' or item.status == 'low_stock' or item.status == 'pre_order' %}
        <button type="button" class="btn btn-success btn-lg w-100" data-bs-toggle="modal" data-bs-target="#orderModal">
            üõí –ö—É–ø–∏—Ç—å 
        </button>
    {% else %}
        <button class="btn btn-secondary btn-lg w-100" disabled>
            –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏
        </button>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–∫–∞–∑–∞ -->
<div class="modal fade" id="orderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑: {{ item.title }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" id="orderForm">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label class="form-label">–ò–º—è *</label>
                        {{ order_form.customer_name }}
                        {% if order_form.customer_name.errors %}
                        <div class="text-danger">{{ order_form.customer_name.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Email *</label>
                            {{ order_form.customer_email }}
                            {% if order_form.customer_email.errors %}
                            <div class="text-danger">{{ order_form.customer_email.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                            {{ order_form.customer_phone }}
                            {% if order_form.customer_phone.errors %}
                            <div class="text-danger">{{ order_form.customer_phone.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ *</label>
                        {{ order_form.customer_address }}
                        {% if order_form.customer_address.errors %}
                        <div class="text-danger">{{ order_form.customer_address.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
                            {{ order_form.quantity }}
                            {% if order_form.quantity.errors %}
                            <div class="text-danger">{{ order_form.quantity.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">–ò—Ç–æ–≥–æ</label>
                            <div class="form-control bg-secondary text-white">
                                <strong id="totalPrice">{{ item.price }} ‚ÇΩ</strong>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                        {{ order_form.notes }}
                        {% if order_form.notes.errors %}
                        <div class="text-danger">{{ order_form.notes.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>‚ÑπÔ∏è –í–∞–∂–Ω–æ:</strong><br>
                        –ü–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –º—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –¥–æ—Å—Ç–∞–≤–∫–∏.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" form="orderForm" class="btn btn-success">
                    üì¶ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
                </button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º—ã -->
            <script>
            document.addEventListener('DOMContentLoaded', function() {
                const quantityInput = document.querySelector('#id_quantity');
                const price = {{ item.price }};
                const totalPriceEl = document.querySelector('#totalPrice');
                
                function updateTotal() {
                    const quantity = parseInt(quantityInput.value) || 1;
                    const total = price * quantity;
                    totalPriceEl.textContent = total.toLocaleString('ru-RU') + ' ‚ÇΩ';
                }
                
                quantityInput.addEventListener('input', updateTotal);
                updateTotal();
            });
            </script>
            
            <div class="alert alert-info">
                <strong>‚ÑπÔ∏è –ö–∞–∫ –∑–∞–∫–∞–∑–∞—Ç—å:</strong><br>
                –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö –∏–ª–∏ –Ω–∞ –ø–æ—á—Ç—É –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞.
            </div>
        </div>
    </div>

<!-- –ü–æ—Ö–æ–∂–∏–µ —Ç–æ–≤–∞—Ä—ã -->
{% if related_items %}
<div class="mt-5">
    <h2 class="mb-3">–ü–æ—Ö–æ–∂–∏–µ —Ç–æ–≤–∞—Ä—ã</h2>
    <div class="row g-4">
        {% for related in related_items %}
        <div class="col-md-3">
            <div class="card h-100 bg-dark border-secondary merch-card">  <!-- –î–û–ë–ê–í–õ–ï–ù –ö–õ–ê–°–° merch-card -->
                <img src="{{ related.image.url }}" class="card-img-top" alt="{{ related.title }}">
                <div class="card-body">
                    <h5 class="card-title">{{ related.title }}</h5>
                    <p class="card-text">
                        <strong>{{ related.price }} ‚ÇΩ</strong>
                    </p>
                    <a href="{% url 'merch_detail' related.slug %}" class="btn btn-outline-primary">
                        –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
</div>
{% endblock %}